<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tic-Tac-Toe Pro Max AI</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script async src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'">
    
    <style>
        :root { 
            --blue: #007bff; 
            --gold: #ffd700; 
            --bg: #050c16; 
            --card-bg: #1a1f26;
            --red: #ff4757; 
            --green: #2ecc71; 
            --wa-green: #25D366; 
        }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        
        /* Header */
        .header { width: 100%; background: #002266; padding: 10px; border-bottom: 3px solid var(--gold); box-sizing: border-box; display: flex; align-items: center; justify-content: space-between; }
        .wallet { color: var(--gold); font-weight: bold; font-size: 18px; flex-grow: 1; text-align: center; }
        .nav-toggle { font-size: 24px; cursor: pointer; color: white; padding: 0 10px; }
        .btn-add-coins { background: var(--green); color: white; border: none; padding: 6px 12px; border-radius: 8px; font-weight: bold; font-size: 12px; cursor: pointer; white-space: nowrap; margin-right: 5px; }

        /* Banner Bar */
        .banner-bar { width: 100%; background: linear-gradient(90deg, #004e92, #000428); padding: 8px; text-align: center; font-size: 12px; border-bottom: 1px solid #333; display: flex; justify-content: center; align-items: center; box-sizing: border-box; }

        .screen { text-align: center; width: 95%; margin-top: 15px; display: none; flex-direction: column; align-items: center; height: 85vh; overflow-y: auto; padding-bottom: 20px; }
        .active { display: flex !important; }
        
        /* Buttons */
        .btn-action { background: linear-gradient(135deg, #007bff, #0056b3); color: white; border: none; padding: 14px; border-radius: 12px; font-weight: bold; width: 80%; margin: 8px 0; cursor: pointer; font-size: 18px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .btn-offline { background: linear-gradient(135deg, #2ecc71, #27ae60) !important; }
        .btn-back { background: #444 !important; width: 40% !important; margin-top: 20px; }
        
        /* Deposit System UI */
        .deposit-card { background: var(--card-bg); border-radius: 15px; padding: 20px; width: 90%; margin-top: 10px; border: 1px solid #333; }
        .preset-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
        .btn-preset { background: #2c3e50; color: white; border: 1px solid var(--blue); padding: 10px; border-radius: 8px; font-size: 14px; cursor: pointer; }
        .btn-preset:active { background: var(--blue); }
        
        .amount-stepper { display: flex; align-items: center; justify-content: center; gap: 20px; margin: 20px 0; }
        .stepper-btn { background: var(--blue); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; }
        #custom-amount { background: transparent; border: none; border-bottom: 2px solid var(--gold); color: white; font-size: 24px; width: 100px; text-align: center; outline: none; }

        /* QR Screen */
        .qr-container { background: white; padding: 15px; border-radius: 15px; margin: 20px 0; }
        .qr-container img { width: 200px; height: 200px; object-fit: contain; }

        /* History/Report Table */
        .history-container { width: 100%; margin-top: 20px; display: none; }
        .report-item { background: #111; border-left: 4px solid var(--gold); padding: 12px; margin-bottom: 10px; text-align: left; border-radius: 0 8px 8px 0; font-size: 13px; }
        .status-pending { color: #ffa500; font-weight: bold; }
        .status-success { color: var(--green); font-weight: bold; }

        /* Original Game Styles */
        #result-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); display:none; flex-direction:column; justify-content:center; align-items:center; z-index: 5000; }
        .board-container { width: 95vw; height: 50vh; overflow: auto; border: 2px solid #2c3e50; background: #000; border-radius: 8px; contain: content; }
        .grid { display: grid; grid-template-columns: repeat(25, 30px); gap: 1px; background: #333; width: max-content; }
        .cell { width: 30px; height: 30px; background: #fff; display: flex; justify-content: center; align-items: center; font-size: 18px; font-weight: 900; color: #333; cursor: pointer; }
        .win-glow { background: var(--green) !important; color: white !important; }
        #timer-bar-wrap { width: 80%; height: 6px; background: #222; border-radius: 3px; margin-bottom: 5px; }
        #timer-bar { width: 100%; height: 100%; background: var(--green); transition: width 0.2s linear; }
   
        #auth-container { position: fixed; inset: 0; background: var(--bg); z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow-y: auto; padding: 20px; }
        .auth-card { background: #ffffff; width: 100%; max-width: 400px; padding: 30px; border-radius: 20px; color: #333; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .auth-card h2 { margin-top: 0; color: var(--blue); text-align: center; }
        .auth-field { margin-bottom: 15px; position: relative; }
        .auth-field input { width: 100%; padding: 12px; border: 1.5px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        .pass-toggle { position: absolute; right: 10px; top: 12px; color: #777; cursor: pointer; }
        .auth-btn { width: 100%; padding: 14px; border: none; border-radius: 10px; background: var(--blue); color: white; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 10px; }
        .auth-switch { text-align: center; margin-top: 15px; color: var(--blue); cursor: pointer; font-weight: 600; }

        #sidebar-drawer { position: fixed; left: -310px; top: 0; width: 300px; height: 100%; background: #fff; z-index: 4000; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 10px 0 30px rgba(0,0,0,0.8); display: flex; flex-direction: column; color: #333; }
        #sidebar-drawer.open { left: 0; }
        .sidebar-header { background: linear-gradient(135deg, var(--blue), #002266); color: white; padding: 40px 20px 20px; display: flex; flex-direction: column; align-items: center; }
        .profile-pic-container { position: relative; width: 90px; height: 90px; margin-bottom: 10px; border-radius: 50%; border: 3px solid var(--gold); overflow: hidden; cursor: pointer; background: #eee; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #sb-photo { width: 100%; height: 100%; object-fit: cover; }
        .edit-badge { position: absolute; bottom: 0; background: rgba(0,0,0,0.6); width: 100%; text-align: center; color: white; font-size: 11px; padding: 4px 0; }
        .sidebar-menu { flex-grow: 1; overflow-y: auto; padding: 10px 0; }
        .menu-item { padding: 15px 25px; display: flex; align-items: center; gap: 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-weight: 500; font-size: 14px; }
        .menu-item i { width: 20px; color: var(--blue); text-align: center; }
        .logout-btn { color: var(--red); display: flex; align-items: center; gap: 15px; cursor: pointer; font-weight: bold; padding: 10px 5px; }
        #sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; z-index: 3900; backdrop-filter: blur(3px); }

        /* Modal for upload */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 7000; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; width: 85%; color: #333; text-align: center; }

        .online-status-container { padding: 10px 25px; display: flex; align-items: center; gap: 10px; background: #f9f9f9; border-bottom: 1px solid #eee; }
        .dot { height: 10px; width: 10px; background-color: var(--green); border-radius: 50%; display: inline-block; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; color: #333; border-radius: 8px; overflow: hidden; }
        .data-table th, .data-table td { padding: 10px; border: 1px solid #eee; font-size: 12px; }
        .data-table th { background: var(--blue); color: white; }

        #play-again-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 6000; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        .play-again-card { background: white; color: #333; padding: 25px; border-radius: 15px; width: 85%; max-width: 320px; }
        .wait-timer { font-size: 30px; font-weight: bold; color: var(--blue); margin: 15px 0; }
        .broadcast-alert { background: var(--gold); color: black; padding: 10px; width: 100%; position: fixed; top: 0; z-index: 10000; display: none; text-align: center; font-weight: bold; border-bottom: 2px solid #000; }
    </style>
</head>
<body onclick="initAudio()">

    <div id="broadcast-bar" class="broadcast-alert"></div>

    <div id="upload-modal" class="modal">
        <div class="modal-content">
            <h3>Upload Screenshot</h3>
            <p>Payment karne ke baad screenshot upload karein.</p>
            <input type="file" id="ss-upload" accept="image/*" style="margin: 20px 0;">
            <button class="btn-action" id="submit-ss-btn" onclick="submitDeposit()">SUBMIT PAYMENT</button>
            <button class="btn-action btn-back" onclick="closeModal()">CANCEL</button>
        </div>
    </div>

    <div id="play-again-overlay">
        <div class="play-again-card" id="pa-waiting-ui" style="display:none;">
            <h3>Waiting for Friend...</h3>
            <div class="wait-timer" id="pa-wait-sec">10</div>
            <p>Please wait while your friend decides.</p>
        </div>
        <div class="play-again-card" id="pa-request-ui" style="display:none;">
            <h3 style="color:var(--blue)">Play Again?</h3>
            <p>Your friend wants a rematch! Accept?</p>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-action" style="background:var(--green); margin:0;" onclick="respondPlayAgain(true)">YES</button>
                <button class="btn-action" style="background:var(--red); margin:0;" onclick="respondPlayAgain(false)">NO</button>
            </div>
        </div>
    </div>

    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div id="sidebar-drawer">
        <div class="sidebar-header">
            <input type="file" id="photo-input" accept="image/*" style="display:none;" onchange="handlePhotoUpload(event)">
            <div class="profile-pic-container" onclick="document.getElementById('photo-input').click()">
                <img id="sb-photo" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" alt="Profile">
                <div class="edit-badge"><i class="fa fa-camera"></i> Edit</div>
            </div>
            <h2 id="sb-name">Guest User</h2>
            <p id="sb-phone">+91 0000000000</p>
        </div>
        
        <div class="online-status-container">
            <span class="dot"></span>
            <span style="font-size: 13px; font-weight: bold; color: #555;">Live Online: <span id="online-count" style="color: var(--green);">1</span></span>
        </div>

        <div class="sidebar-menu">
            <div class="menu-item" onclick="nav('screen-mode')"><i class="fa fa-home"></i> Home</div>
            <div class="menu-item" onclick="document.getElementById('photo-input').click()"><i class="fa fa-user"></i> Change Photo</div>
            <div class="menu-item"><i class="fa fa-qrcode"></i> Refer Code: <b id="sb-refer" style="margin-left:5px">---</b></div>
            <div class="menu-item" onclick="loadMyTeam()"><i class="fa fa-users"></i> My Join Team</div>
            <div class="menu-item" onclick="openSharePage()"><i class="fa fa-share-alt"></i> Share App Link</div>
            <div class="menu-item" onclick="nav('screen-wallet-info')"><i class="fa fa-wallet"></i> Wallet / Balance</div>
            <div class="menu-item" onclick="nav('screen-deposit')"><i class="fa fa-plus-circle"></i> Add Coins</div>
            <div class="menu-item" onclick="nav('screen-help')"><i class="fa fa-headset"></i> Help & Support</div>
            <div class="menu-item" onclick="nav('screen-rules')"><i class="fa fa-file-alt"></i> Terms & Conditions</div>
        </div>
        <div class="sidebar-footer">
            <div class="logout-btn" onclick="logout()"><i class="fa fa-sign-out-alt"></i> Logout</div>
        </div>
    </div>

    <div id="auth-container">
        <div id="signup-card" class="auth-card">
            <h2>Create Account</h2>
            <div class="auth-field"><input type="text" id="reg-name" placeholder="Full Name"></div>
            <div class="auth-field"><input type="tel" id="reg-phone" placeholder="Mobile Number"></div>
            <div class="auth-field">
                <input type="password" id="reg-pass" placeholder="Password">
                <i class="fa fa-eye pass-toggle" onclick="togglePass('reg-pass')"></i>
            </div>
            <div class="auth-field">
                <input type="password" id="reg-cpass" placeholder="Confirm Password">
                <i class="fa fa-eye pass-toggle" onclick="togglePass('reg-cpass')"></i>
            </div>
            <div class="auth-field"><input type="text" id="reg-refer" placeholder="Refer Code (Optional)"></div>
            <button class="auth-btn" id="signup-btn" onclick="handleSignup()">SIGN UP</button>
            <div class="auth-switch" onclick="switchAuth('login')">Already have an account? Login</div>
        </div>
        <div id="login-card" class="auth-card" style="display:none;">
            <h2>Welcome Back</h2>
            <div class="auth-field"><input type="tel" id="log-phone" placeholder="Mobile Number"></div>
            <div class="auth-field">
                <input type="password" id="log-pass" placeholder="Password">
                <i class="fa fa-eye pass-toggle" onclick="togglePass('log-pass')"></i>
            </div>
            <button class="auth-btn" id="login-btn" onclick="handleLogin()">LOGIN</button>
            <div class="auth-switch" onclick="switchAuth('signup')">New user? Create Account</div>
        </div>
    </div>

    <div class="header" id="main-header">
        <i class="fa fa-bars nav-toggle" onclick="toggleSidebar()"></i>
        <div class="wallet">üí∞ <span id="balance">1000</span></div>
        <button class="btn-add-coins" onclick="showScreen('screen-deposit')"><i class="fa fa-plus-circle"></i> ADD COINS</button>
    </div>

    <div class="banner-bar" id="top-banner">
        <span>üì¢ Win Big with Tic-Tac-Toe Pro!</span>
        </div>

    <div id="result-overlay">
        <h1 id="result-text" style="font-size: 40px;">WINNER!</h1>
    </div>

    <div id="screen-deposit" class="screen">
        <h2 style="color:var(--gold); margin-bottom:5px;">ADD COINS</h2>
        <p style="font-size:13px; margin-bottom:15px;">Welcome! Coins add karke khelna shuru karein.</p>
        
        <button class="btn-action" style="width:90%; background: #2c3e50;" onclick="toggleHistory()">üìã LOAD REPORT (HISTORY)</button>
        
        <div id="history-section" class="history-container">
            <h4 style="text-align:left; margin-bottom:10px;">Transaction History</h4>
            <div id="history-list">
                </div>
        </div>

        <div class="deposit-card">
            <p style="margin:0; font-weight:bold;">Select Amount</p>
            <div class="preset-grid">
                <button class="btn-preset" onclick="setDepositAmt(300)">+300</button>
                <button class="btn-preset" onclick="setDepositAmt(500)">+500</button>
                <button class="btn-preset" onclick="setDepositAmt(1000)">+1k</button>
                <button class="btn-preset" onclick="setDepositAmt(5000)">+5k</button>
                <button class="btn-preset" onclick="setDepositAmt(10000)">+10k</button>
                <button class="btn-preset" onclick="setDepositAmt(300)">Min</button>
            </div>
            
            <div class="amount-stepper">
                <button class="stepper-btn" onclick="adjustAmt(-50)">-</button>
                <input type="number" id="custom-amount" value="300">
                <button class="stepper-btn" onclick="adjustAmt(50)">+</button>
            </div>
            
            <button class="btn-action" style="width:100%; margin:0;" onclick="goToQR()">ADD NOW</button>
        </div>
        <button class="btn-action btn-back" onclick="showScreen('screen-mode')">BACK</button>
    </div>

    <div id="screen-qr" class="screen">
        <h2 style="color:var(--gold)">SCAN & PAY</h2>
        <div class="deposit-card">
            <h3 style="margin:0; color:var(--blue);">Amount: ‚Çπ<span id="qr-amt-disp">300</span></h3>
            <div class="qr-container">
                <img id="qr-payment-img" src="https://via.placeholder.com/200?text=Scan+Me" alt="QR Code">
            </div>
            <p style="font-size:12px; color:#ccc;">QR code scan karke payment karein aur screenshot lein.</p>
            <button class="btn-action" style="background:var(--green); width:100%;" onclick="openUploadModal()">PAY NOW (UPLOAD SS)</button>
        </div>
        <button class="btn-action btn-back" onclick="showScreen('screen-deposit')">BACK</button>
    </div>

    <div id="screen-mode" class="screen active">
        <h2 style="color:var(--gold)">CHOOSE MODE</h2>
        <button class="btn-action" onclick="setMode('AI')">VS COMPUTER üíª</button>
        <button class="btn-action" onclick="setMode('FRIEND')">VS FRIEND (ONLINE) üë•</button>
        <button class="btn-action btn-offline" onclick="startOfflineMode()">VS FRIEND (OFFLINE) ü§ù</button>
    </div>

    <div id="screen-share-page" class="screen">
        <div class="share-header">
            <i class="fa fa-arrow-left" onclick="showScreen('screen-mode')"></i>
            <h2 style="margin:0; font-size: 20px;">Share Game</h2>
        </div>
        <div class="share-content">
            <div style="margin-bottom: 30px; text-align: center;">
                <i class="fa fa-link" style="font-size: 50px; color: white; margin-bottom: 15px;"></i>
                <p style="font-weight: bold; font-size: 18px;">Doston ko invite karein!</p>
            </div>
            <button class="btn-copy" onclick="copyGameLink()">Copy Game Link</button>
            <p id="copy-msg" style="margin-top: 15px; font-weight: bold; display: none;">Copied! ‚úÖ</p>
        </div>
    </div>

    <div id="screen-wallet-info" class="screen">
        <h2 style="color:var(--gold)">COIN PRICING</h2>
        <table class="data-table">
            <tr><th>Coins</th><th>Price (Rs)</th></tr>
            <tr><td>100 Coins</td><td>40 Rs</td></tr>
            <tr><td>200 Coins</td><td>70 Rs</td></tr>
            <tr><td>500 Coins</td><td>140 Rs</td></tr>
            <tr><td>1000 Coins</td><td>250 Rs</td></tr>
        </table>
        <p style="font-size:12px; margin-top:15px;">Contact support to buy coins.</p>
        <button class="btn-action btn-back" onclick="showScreen('screen-mode')">BACK</button>
    </div>

    <div id="screen-help" class="screen">
        <h2 style="color:var(--gold)">HELP & SUPPORT</h2>
        <div class="qr-help-container" style="background:white; padding:20px; border-radius:15px; display:flex; flex-direction:column; align-items:center;">
            <p style="color:#333; font-weight:bold; margin-bottom:10px;">Official WhatsApp Support</p>
            <img id="qr-support-img" src="https://via.placeholder.com/200?text=Support" alt="WhatsApp QR Code" style="width:200px;">
            <p style="color:#555; font-size:13px; margin-top:10px;">Number: +966 578913144</p>
            <button class="btn-action wa-btn" style="background:var(--wa-green) !important;" onclick="contactWhatsAppDirect()">
                <i class="fab fa-whatsapp"></i> CHAT ON WHATSAPP
            </button>
        </div>
        <button class="btn-action btn-back" onclick="showScreen('screen-mode')">BACK</button>
    </div>

    <div id="screen-rules" class="screen">
        <h2 style="color:var(--gold)">GAME RULES</h2>
        <div style="text-align:left; padding:15px; font-size:14px; line-height:1.6;">
            1. Yeh 25x25 ka bada grid game hai.<br>
            2. Aapko lagatar <b>5 Symbols</b> (Horizontal, Vertical ya Diagonal) banane honge.<br>
            3. Jo pehle 5 line mein banayega, woh winner hoga.<br>
            4. Har move ke liye <b>30 second</b> ka waqt milega.<br>
            5. Time khatam hone par computer apne aap move chal dega.<br>
            6. Coins haarne par wallet se deduct honge aur jeetne par double milenge.
        </div>
        <button class="btn-action btn-back" onclick="showScreen('screen-mode')">BACK</button>
    </div>

    <div id="screen-team" class="screen">
        <h2 style="color:var(--gold)">MY JOIN TEAM</h2>
        <div id="team-list-container" style="width:100%;">
            <table class="data-table">
                <thead><tr><th>Name</th><th>Number</th><th>Date/Time</th></tr></thead>
                <tbody id="team-body"></tbody>
            </table>
        </div>
        <button class="btn-action btn-back" onclick="showScreen('screen-mode')">BACK</button>
    </div>

    <div id="screen-bet" class="screen">
        <h2 style="color:white">SELECT BET</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 90%;">
            <button class="btn-action" onclick="selectBet(10)">10</button>
            <button class="btn-action" onclick="selectBet(50)">50</button>
            <button class="btn-action" onclick="selectBet(100)">100</button>
            <button class="btn-action" onclick="selectBet(500)">500</button>
        </div>
        <button class="btn-action btn-back" onclick="showScreen('screen-mode')">BACK</button>
    </div>

    <div id="screen-room" class="screen">
        <h2 style="color:var(--gold)">ROOM CODE</h2>
        <h1 id="roomCodeDisp" style="font-size: 40px; color: var(--gold); letter-spacing: 5px;">----</h1>
        <button class="btn-action" onclick="createRoom()">CREATE CODE</button>
        <input type="number" id="roomInput" placeholder="Enter Code" style="padding:12px; width:70%; border-radius:8px; margin: 10px 0;">
        <button class="btn-action" style="background:var(--green); color:black;" onclick="joinRoom()">JOIN FRIEND</button>
        <button class="btn-action btn-back" onclick="showScreen('screen-bet')">BACK</button>
    </div>

    <div id="game-screen" class="screen">
        <div id="status" style="color:cyan; font-weight:bold; margin-bottom:5px;">Intezar...</div>
        <div id="timer-bar-wrap"><div id="timer-bar"></div></div>
        <div class="board-container"><div class="grid" id="main-grid"></div></div>
        <div id="win-display" style="color:gold; font-size:14px;">WINNING: <span id="win-amt">0</span></div>
        
        <div id="game-controls">
            <button class="btn-action" id="pa-btn" style="width: 50%;" onclick="requestPlayAgain()">PLAY AGAIN üîÑ</button>
            <button class="btn-action" style="background:var(--red); width: 40%;" onclick="quitGame()">QUIT</button>
        </div>
        <button id="mid-game-quit" class="btn-action" style="background:var(--red); width:auto; padding:8px 30px; margin-top:10px;" onclick="quitGame()">QUIT</button>
    </div>

    <script>
        /* FIREBASE CONFIGURATION 
           Yahan apna asli Firebase config details dalein agar aapke paas hain.
           Agar nahi hain toh sirf databaseURL se bhi kaam chalega lekin production ke liye poora config behtar hai.
        */
        const firebaseConfig = {
  apiKey: "AIzaSyAAqOJP30w7TEMXG8oHUmMTDpOy8BjboDY", // Nayi Key yahan update ho gayi hai
  authDomain: "gameadda-48c68.firebaseapp.com",
  databaseURL: "https://gameadda-48c68-default-rtdb.firebaseio.com",
  projectId: "gameadda-48c68",
  storageBucket: "gameadda-48c68.appspot.com",
  messagingSenderId: "333499445245",
  appId: "1:333499445245:web:5227528c6c0004677ef394",
  measurementId: "G-DKV9ZE837"
};


        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Speed Boost: Force-bypass loader after 6 seconds if it's stuck
        setTimeout(() => {
            const auth = document.getElementById('auth-container');
            if(auth && auth.style.display !== 'none' && localStorage.getItem('ttt_user')) {
                auth.style.display = 'none';
            }
        }, 6000);

        let audioCtx, wallet = 1000;
        let board = [], active = false, mode = '', bet = 0, mySymbol = 'X', turn = 'X', roomCode = '';
        let tVal = 30, tInt, currentUser = null;
        let paTimer = null;

        /* --- FIREBASE DYNAMIC QR SYNC --- */
        db.ref('system/payment_qr').on('value', snap => {
            if(snap.exists()) {
                const qrUrl = snap.val();
                document.getElementById('qr-payment-img').src = qrUrl;
                if(document.getElementById('qr-support-img')) {
                    document.getElementById('qr-support-img').src = qrUrl;
                }
            }
        });

        /* --- UPDATED DEPOSIT SYSTEM LOGIC --- */
        let depositHistory = JSON.parse(localStorage.getItem('deposit_history')) || [];

        function setDepositAmt(val) { document.getElementById('custom-amount').value = val; }
        function adjustAmt(val) {
            let curr = parseInt(document.getElementById('custom-amount').value);
            if(curr + val >= 300) document.getElementById('custom-amount').value = curr + val;
        }

        function toggleHistory() {
            const hist = document.getElementById('history-section');
            hist.style.display = hist.style.display === 'block' ? 'none' : 'block';
            renderHistory();
        }

        function goToQR() {
            let amt = parseInt(document.getElementById('custom-amount').value);
            if(amt < 300) return alert("Minimum Add Coins ‚Çπ300 hai.");
            document.getElementById('qr-amt-disp').innerText = amt;
            showScreen('screen-qr');
        }

        function openUploadModal() { document.getElementById('upload-modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('upload-modal').style.display = 'none'; }

        async function submitDeposit() {
            const fileInput = document.getElementById('ss-upload');
            const submitBtn = document.getElementById('submit-ss-btn');
            
            if(!fileInput.files[0]) return alert("Please select a screenshot first!");
            if(!currentUser) return alert("Please login first!");

            submitBtn.disabled = true;
            submitBtn.innerText = "UPLOADING...";

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = async (e) => {
                const base64Image = e.target.result;
                const amt = document.getElementById('qr-amt-disp').innerText;
                const now = new Date();
                const dateStr = now.toLocaleString();

                const uploadData = {
                    userId: currentUser.phone,
                    amount: amt,
                    image: base64Image,
                    time: dateStr,
                    status: 'Pending'
                };

                try {
                    await db.ref('system/user_uploads').push(uploadData);
                    await db.ref('users/' + currentUser.phone + '/last_upload').set(base64Image);

                    let entry = { date: dateStr, amount: amt, status: 'Pending' };
                    depositHistory.unshift(entry);
                    localStorage.setItem('deposit_history', JSON.stringify(depositHistory));
                    
                    alert("Payment proof submitted! Coins will be added after admin verification.");
                    closeModal();
                    showScreen('screen-deposit');
                    renderHistory();
                } catch(error) {
                    alert("Error uploading: " + error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerText = "SUBMIT PAYMENT";
                }
            };

            reader.readAsDataURL(file);
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            if(!list) return;
            list.innerHTML = depositHistory.length ? "" : "<p style='font-size:12px; opacity:0.6;'>No deposits found.</p>";
            depositHistory.forEach(item => {
                list.innerHTML += `
                    <div class="report-item">
                        <b>Date:</b> ${item.date} | <b>Amount:</b> ‚Çπ${item.amount}<br>
                        <b>Status:</b> <span class="status-pending">${item.status}</span>
                    </div>
                `;
            });
        }

        function togglePass(id) {
            const x = document.getElementById(id);
            x.type = x.type === "password" ? "text" : "password";
        }

        function toggleSidebar() {
            const side = document.getElementById('sidebar-drawer');
            const over = document.getElementById('sidebar-overlay');
            if (side.classList.contains('open')) { side.classList.remove('open'); over.style.display = 'none'; }
            else { side.classList.add('open'); over.style.display = 'block'; }
        }

        function nav(screenId) { showScreen(screenId); toggleSidebar(); }
        function showScreen(id) { 
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); 
            document.getElementById(id).classList.add('active'); 
            if(id === 'screen-share-page') document.getElementById('main-header').style.display = 'none';
            else document.getElementById('main-header').style.display = 'flex';
        }

        async function handleSignup() {
            const btn = document.getElementById('signup-btn');
            const name = document.getElementById('reg-name').value.trim();
            const phone = document.getElementById('reg-phone').value.trim();
            const pass = document.getElementById('reg-pass').value;
            const refer = document.getElementById('reg-refer').value.trim();

            if (!name || phone.length < 10 || pass.length < 4) return alert("Sahi Details bharein!");
            btn.disabled = true; btn.innerText = "Processing...";

            try {
                const snap = await db.ref('users/' + phone).once('value');
                if (snap.exists()) { alert("Mobile Number already registered!"); }
                else {
                    const myReferCode = "REF" + phone.slice(-4);
                    const dateStr = new Date().toLocaleString();
                    const userData = { name, phone, pass, coins: 1000, referCode: myReferCode, joinedRefer: refer || 'none', profilePic: "https://cdn-icons-png.flaticon.com/512/149/149071.png", joinDate: dateStr, notification: "" };
                    
                    if(refer) {
                        const referSnap = await db.ref('users').orderByChild('referCode').equalTo(refer).once('value');
                        if(referSnap.exists()) {
                            const referrerId = Object.keys(referSnap.val())[0];
                            await db.ref('teams/' + referrerId).push({ name: name, phone: phone, date: dateStr });
                        }
                    }
                    await db.ref('users/' + phone).set(userData);
                    completeLogin(userData);
                }
            } catch(e) { alert("Error: " + e.message); }
            finally { btn.disabled = false; btn.innerText = "SIGN UP"; }
        }

        async function handleLogin() {
            const btn = document.getElementById('login-btn');
            const phone = document.getElementById('log-phone').value.trim();
            const pass = document.getElementById('log-pass').value;
            if(!phone || !pass) return alert("Mobile and Password required!");
            btn.disabled = true; btn.innerText = "Checking...";

            try {
                const snap = await db.ref('users/' + phone).once('value');
                if (snap.exists()) {
                    const userData = snap.val();
                    if (userData.pass === pass) { completeLogin(userData); }
                    else { alert("Galt Password!"); }
                } else { alert("Mobile Number nahi mila! Register karein."); }
            } catch (error) { alert("Server Connection Error!"); }
            finally { btn.disabled = false; btn.innerText = "LOGIN"; }
        }

        function completeLogin(user) {
            currentUser = user;
            localStorage.setItem('ttt_user', JSON.stringify(user));
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('sb-name').innerText = user.name;
            document.getElementById('sb-phone').innerText = "+91 " + user.phone;
            document.getElementById('sb-refer').innerText = user.referCode;
            if(user.profilePic) document.getElementById('sb-photo').src = user.profilePic;
            
            db.ref('users/' + user.phone + '/coins').on('value', snap => {
                if(snap.exists()) {
                    wallet = snap.val();
                    updateUI();
                }
            });

            updateUI();
            setupOnlineCounter(user.phone);
            listenForNotifications();
        }

        function listenForNotifications() {
            db.ref('users/' + currentUser.phone + '/notification').on('value', snap => {
                const msg = snap.val();
                if(msg && msg !== "") {
                    const bar = document.getElementById('broadcast-bar');
                    bar.innerText = "üì¢ ADMIN: " + msg;
                    bar.style.display = 'block';
                    setTimeout(() => { bar.style.display = 'none'; db.ref('users/' + currentUser.phone).update({notification: ""}); }, 10000);
                }
            });
        }

        function setupOnlineCounter(userId) {
            const onlineRef = db.ref('online_users/' + userId);
            db.ref('.info/connected').on('value', snap => { if (snap.val()) { onlineRef.set(true); onlineRef.onDisconnect().remove(); } });
            db.ref('online_users').on('value', snap => {
                const count = snap.numChildren();
                const el = document.getElementById('online-count');
                if(el) el.innerText = count;
            });
        }

        function openSharePage() { toggleSidebar(); showScreen('screen-share-page'); }

        function copyGameLink() {
            const gameLink = "https://imran13144.github.io/Tic-Tac-Toe-Dawnload/";
            const shareText = `Tic-Tac-Toe Pro Max join karein! üéÆ\nRefer Code: ${currentUser.referCode}\nLink: ${gameLink}`;
            navigator.clipboard.writeText(shareText).then(() => {
                document.getElementById('copy-msg').style.display = 'block';
                setTimeout(() => document.getElementById('copy-msg').style.display = 'none', 2000);
            });
        }

        function contactWhatsAppDirect() { window.location.href = `https://wa.me/966578913144?text=Help%20Needed`; }

        async function loadMyTeam() {
            showScreen('screen-team'); toggleSidebar();
            const body = document.getElementById('team-body');
            body.innerHTML = "<tr><td colspan='3'>Loading...</td></tr>";
            try {
                const snap = await db.ref('teams/' + currentUser.phone).once('value');
                body.innerHTML = snap.exists() ? "" : "<tr><td colspan='3'>No members yet.</td></tr>";
                snap.forEach(child => {
                    const d = child.val();
                    body.innerHTML += `<tr><td>${d.name}</td><td>${d.phone}</td><td>${d.date}</td></tr>`;
                });
            } catch(e) { body.innerHTML = "Error loading team."; }
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = e.target.result;
                await db.ref('users/' + currentUser.phone).update({ profilePic: base64 });
                currentUser.profilePic = base64;
                localStorage.setItem('ttt_user', JSON.stringify(currentUser));
                document.getElementById('sb-photo').src = base64;
            };
            reader.readAsDataURL(file);
        }

        function logout() { 
            if(currentUser) db.ref('online_users/' + currentUser.phone).remove();
            localStorage.removeItem('ttt_user'); location.reload(); 
        }

        function switchAuth(type) {
            document.getElementById('signup-card').style.display = type === 'signup' ? 'block' : 'none';
            document.getElementById('login-card').style.display = type === 'login' ? 'block' : 'none';
        }

        function initAudio() { if (!audioCtx) audioCtx = new (AudioContext || webkitAudioContext)(); }
        function playSound(f) { if(!audioCtx) return; let o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.frequency.setValueAtTime(f, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.1); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.1); }
        function updateUI() { document.getElementById('balance').innerText = wallet; }

        function setMode(m) { mode = m; if(mode === 'OFFLINE') startOfflineMode(); else showScreen('screen-bet'); }
        function startOfflineMode() { mode = 'OFFLINE'; bet = 0; document.getElementById('win-display').style.visibility = 'hidden'; initGame(); }
        function selectBet(amt) { if(amt > wallet) return alert("Low Coins!"); bet = amt; document.getElementById('win-display').style.visibility = 'visible'; document.getElementById('win-amt').innerText = bet * 2; if(mode === 'FRIEND') showScreen('screen-room'); else initGame(); }

        function createRoom() {
            roomCode = Math.floor(1000 + Math.random() * 9000).toString();
            document.getElementById('roomCodeDisp').innerText = roomCode;
            mySymbol = 'X';
            db.ref('rooms/' + roomCode).set({ status: 'waiting', bet: bet, turn: 'X', joinRequested: false, restartRequest: 'none', quitter: 'none' });
            listenToRoom();
        }

        function joinRoom() {
            let code = document.getElementById('roomInput').value;
            if(!code) return alert("Enter code!");
            db.ref('rooms/' + code).once('value', snapshot => {
                let data = snapshot.val();
                if(data && data.status === 'waiting') {
                    if(data.bet !== bet) return alert(`Bet mismatch! Host bet is ${data.bet}`);
                    roomCode = code; mySymbol = 'O';
                    db.ref('rooms/' + roomCode).update({ joinRequested: true });
                    listenToRoom();
                } else alert("Room Invalid!");
            });
        }

        function listenToRoom() {
            db.ref('rooms/' + roomCode).on('value', snapshot => {
                let data = snapshot.val();
                if(!data) return;
                
                if(mySymbol === 'X' && data.joinRequested === true && data.status === 'waiting') {
                    db.ref('rooms/' + roomCode).update({ joinRequested: 'pending' });
                    if(confirm("Player joining, accept?")) db.ref('rooms/' + roomCode).update({ status: 'playing' });
                    else quitGame();
                }
                
                if(data.status === 'playing' && !active) { closePlayAgainUI(); initGame(); }

                if(data.lastMove && data.lastMove.p !== mySymbol && active && turn !== mySymbol) {
                    renderMove(data.lastMove.r, data.lastMove.c, data.lastMove.p);
                }

                if(data.quitter && data.quitter !== 'none' && active) {
                    if(data.quitter !== mySymbol) endGame(mySymbol, []); 
                }

                if(data.status === 'finished' && active) { endGame(data.winner, data.winPath || []); }

                if(data.restartRequest === 'requested' && data.requester !== mySymbol) { showPlayAgainUI('request'); }
                
                if(data.restartRequest === 'denied') { alert("Friend declined rematch."); quitGame(); }
            });
        }

        function initGame() {
            if(mode !== 'OFFLINE' && !active) { 
                wallet -= bet; 
                updateUI();
                if(currentUser) db.ref('users/'+currentUser.phone).update({coins: wallet});
            }
            showScreen('game-screen'); 
            active = true; turn = 'X';
            document.getElementById('game-controls').style.display = 'none';
            document.getElementById('mid-game-quit').style.display = 'block';
            
            board = Array(25).fill().map(() => Array(25).fill(''));
            const g = document.getElementById('main-grid'); 
            
            let fragment = document.createDocumentFragment();
            for(let r=0; r<25; r++) {
                for(let c=0; c<25; c++) {
                    let cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.id = `c-${r}-${c}`;
                    cell.addEventListener('click', () => { 
                        if(!active || board[r][c] !== '' || (mode==='FRIEND' && turn!==mySymbol)) return;
                        processMove(r, c, turn);
                    });
                    fragment.appendChild(cell);
                }
            }
            g.innerHTML = ''; g.appendChild(fragment);
            startTimer(); updateStatusText();
        }

        function processMove(r, c, p) {
            renderMove(r, c, p);
            if(mode === 'FRIEND' && p === mySymbol) {
                db.ref('rooms/'+roomCode).update({lastMove:{r,c,p:mySymbol}, turn:(mySymbol==='X'?'O':'X')});
            }
        }

        function renderMove(r, c, p) {
            if(board[r][c] !== '') return;
            board[r][c] = p;
            let el = document.getElementById(`c-${r}-${c}`);
            if(el) { el.innerText = p; el.style.color = p==='X'?'#ff4757':'#007bff'; }
            playSound(p === 'X' ? 600 : 400);
            
            let win = checkWin(r, c, p);
            if(win) {
                if(mode === 'FRIEND' && p === mySymbol) {
                    db.ref('rooms/' + roomCode).update({ status: 'finished', winner: p, winPath: win });
                }
                return endGame(p, win);
            }
            
            turn = (p === 'X' ? 'O' : 'X');
            if(mode === 'OFFLINE') mySymbol = turn;
            updateStatusText();
            if(mode === 'AI' && turn === 'O' && active) setTimeout(runGodAI, 200);
            startTimer();
        }

        function checkWin(r, c, p) {
            const dirs = [[0,1],[1,0],[1,1],[1,-1]];
            for(let [dr, dc] of dirs) {
                let path = [[r,c]];
                [[dr, dc], [-dr, -dc]].forEach(([sr, sc]) => {
                    let nr=r+sr, nc=c+sc;
                    while(nr>=0 && nr<25 && nc>=0 && nc<25 && board[nr][nc] === p) { path.push([nr, nc]); nr+=sr; nc+=sc; }
                });
                if(path.length >= 5) return path;
            } return null;
        }

        function runGodAI() {
            if(!active) return;
            let move = findWinningMove('O', 5) || findWinningMove('X', 5) || findWinningMove('X', 4) || findWinningMove('O', 4) || findBestStrategic();
            if(move) processMove(move.r, move.c, 'O');
        }

        function findWinningMove(p, n) {
            for(let r=0; r<25; r++) for(let c=0; c<25; c++) {
                if(board[r][c] === '') {
                    board[r][c] = p;
                    if(checkPotentialWin(r, c, p, n)) { board[r][c] = ''; return {r,c}; }
                    board[r][c] = '';
                }
            } return null;
        }

        function checkPotentialWin(r, c, p, n) {
            const dirs = [[0,1],[1,0],[1,1],[1,-1]];
            for(let [dr, dc] of dirs) {
                let count = 1;
                [[dr, dc], [-dr, -dc]].forEach(([sr, sc]) => {
                    let nr=r+sr, nc=c+sc;
                    while(nr>=0 && nr<25 && nc>=0 && nc<25 && board[nr][nc] === p) { count++; nr+=sr; nc+=sc; }
                });
                if(count >= n) return true;
            } return false;
        }

        function findBestStrategic() {
            for(let r=0; r<25; r++) for(let c=0; c<25; c++) {
                if(board[r][c] === '' && hasNeighbor(r,c)) return {r,c};
            } return {r:12, c:12};
        }

        function hasNeighbor(r,c) {
            for(let i=-1; i<=1; i++) for(let j=-1; j<=1; j++) {
                let nr=r+i, nc=c+j;
                if(nr>=0 && nr<25 && nc>=0 && nc<25 && board[nr][nc]!=='') return true;
            } return false;
        }

        function handleTimeout() {
            if(!active) return;
            let emptyCells = [];
            for(let r=0; r<25; r++) for(let c=0; c<25; c++) if(board[r][c] === '') emptyCells.push({r,c});
            if(emptyCells.length > 0) {
                let randomCell = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                processMove(randomCell.r, randomCell.c, turn);
            }
        }

        function endGame(p, path) {
            if(!active) return;
            active = false; clearInterval(tInt);
            path.forEach(([r, c]) => document.getElementById(`c-${r}-${c}`)?.classList.add('win-glow'));
            
            const resOverlay = document.getElementById('result-overlay');
            const resText = document.getElementById('result-text');
            
            if(p === mySymbol && mode !== 'OFFLINE') { 
                wallet += (bet * 2); celebrateWin(); resText.innerText = "YOU WIN! üéâ"; 
            } else if(mode === 'OFFLINE') { 
                resText.innerText = p + " WINS! üèÜ"; celebrateWin(); 
            } else { resText.innerText = "YOU LOSE! üíÄ"; }
            
            resOverlay.style.display = 'flex';
            setTimeout(() => {
                resOverlay.style.display = 'none';
                document.getElementById('game-controls').style.display = 'flex';
                document.getElementById('mid-game-quit').style.display = 'none';
            }, 2000);

            updateUI();
            if(currentUser) db.ref('users/'+currentUser.phone).update({coins: wallet});
        }

        function updateStatusText() { document.getElementById('status').innerText = (mode==='OFFLINE') ? "Player " + turn : (turn === mySymbol) ? "Aapki Turn" : "Virodhi Turn..."; }
        
        function startTimer() { 
            tVal = 30; clearInterval(tInt); 
            tInt = setInterval(() => { 
                tVal -= 0.2; 
                const bar = document.getElementById('timer-bar');
                if(bar) bar.style.width = (tVal/30*100) + "%"; 
                if(tVal <= 0 && active) { clearInterval(tInt); handleTimeout(); } 
            }, 200); 
        }

        function requestPlayAgain() {
            if(mode === 'FRIEND') {
                showPlayAgainUI('waiting');
                db.ref('rooms/' + roomCode).update({ restartRequest: 'requested', requester: mySymbol, lastMove: null, status: 'finishing' });
                let timeLeft = 10;
                paTimer = setInterval(() => {
                    timeLeft--;
                    document.getElementById('pa-wait-sec').innerText = timeLeft;
                    if(timeLeft <= 0) { clearInterval(paTimer); db.ref('rooms/' + roomCode).update({ restartRequest: 'denied' }); }
                }, 1000);
            } else { initGame(); }
        }

        function respondPlayAgain(accepted) {
            clearInterval(paTimer);
            if(accepted) { db.ref('rooms/' + roomCode).update({ restartRequest: 'none', status: 'playing', lastMove: null }); } 
            else { db.ref('rooms/' + roomCode).update({ restartRequest: 'denied' }); quitGame(); }
            closePlayAgainUI();
        }

        function showPlayAgainUI(type) {
            document.getElementById('play-again-overlay').style.display = 'flex';
            document.getElementById('pa-waiting-ui').style.display = type === 'waiting' ? 'block' : 'none';
            document.getElementById('pa-request-ui').style.display = type === 'request' ? 'block' : 'none';
        }

        function closePlayAgainUI() { clearInterval(paTimer); document.getElementById('play-again-overlay').style.display = 'none'; }

        function quitGame() { 
            if(active && mode === 'FRIEND' && roomCode) { db.ref('rooms/' + roomCode).update({ quitter: mySymbol }); }
            clearInterval(tInt); active = false; closePlayAgainUI();
            if(roomCode) db.ref('rooms/'+roomCode).remove();
            roomCode = ''; showScreen('screen-mode');
            document.getElementById('result-overlay').style.display = 'none';
        }

        function celebrateWin() { if(typeof confetti === 'function') confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }

        window.onload = function() {
            const saved = localStorage.getItem('ttt_user');
            if (saved) {
                try { 
                    const parsed = JSON.parse(saved);
                    completeLogin(parsed); 
                    // Immediate bypass of auth if user exists
                    document.getElementById('auth-container').style.display = 'none';
                } 
                catch(e) { localStorage.removeItem('ttt_user'); }
            }
            renderHistory();
        };
    </script>
</body>
</html>
